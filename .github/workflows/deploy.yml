name: Manual Deploy to S3 & Trello Notify

# Kept as manual trigger to meet project requirements
on:
  workflow_dispatch:

jobs:
  # JOB 1: Deploy to S3
  deploy-s3:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2 
      - name: Sync files to S3
      # Sync the contents of the repository to the specified S3 bucket
        run: aws s3 sync ./ s3://cloud-resume-infra --delete

  # JOB 2: Invalidate CloudFront
  invalidate-cloudfront:
    runs-on: ubuntu-latest
    # This job depends on the successful completion of the deploy-s3 job
    needs: deploy-s3 
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Invalidate CloudFront
        # Invalidate all files in the specified CloudFront distribution to ensure the latest content is served
        run: aws cloudfront create-invalidation --distribution-id E2TGEHADFWRLD3 --paths "/*"

  # JOB 3: Create Trello Card (TrisNol Version)
  create-trello-card:
    runs-on: ubuntu-latest
    needs: invalidate-cloudfront # Waits for CloudFront to finish
    steps:
      - name: Create Trello Card
        uses: TrisNol/trello-create-card-action@main
        with:
          # I updated the text to reflect that this is a DEPLOY event
          card_name: "âœ… Deploy Success: ${{ github.ref_name }}"
          card_description: "The website was successfully deployed to AWS S3 and CloudFront. Triggered by: ${{ github.actor }}."
          
          # Your secrets
          api_key: ${{ secrets.TRELLO_API_KEY }}
          token: ${{ secrets.TRELLO_API_TOKEN }}
          board_id: ${{ secrets.TRELLO_BOARD_ID }}
          list_id: ${{ secrets.TRELLO_LIST2_ID }}